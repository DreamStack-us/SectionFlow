name: Auto-Heal

on:
  workflow_dispatch:
    inputs:
      issue_id:
        description: "Issue ID (e.g., SF-001)"
        required: true
      error_type:
        description: "Type of error"
        required: true
        type: choice
        options:
          - type_error
          - build_error
          - runtime_error
          - api_error
      error_context:
        description: "Error details and context"
        required: true
      analysis:
        description: "Initial analysis and recommended fix"
        required: false

env:
  BUN_VERSION: "1.3.3"

jobs:
  heal:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Setup Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Create healing branch
        run: |
          git checkout -b bugfix/auto-heal-${{ inputs.issue_id }}

      - name: Run Healing Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          claude-code --print --dangerously-skip-permissions \
            "You are the SectionFlow Healing Agent. Fix the following issue:

            Issue ID: ${{ inputs.issue_id }}
            Error Type: ${{ inputs.error_type }}

            Error Context:
            ${{ inputs.error_context }}

            Analysis:
            ${{ inputs.analysis }}

            Instructions:
            1. Analyze the error and identify the root cause
            2. Make the minimal fix necessary
            3. Ensure the fix follows TypeScript strict mode patterns
            4. Run 'bun run typecheck' and 'bun run build' to verify
            5. Focus only on src/ directory files
            6. Commit your changes with message: 'fix(${{ inputs.error_type }}): auto-heal ${{ inputs.issue_id }}'
            "

      - name: Run verification
        run: |
          bun run typecheck
          bun run build

      - name: Commit and push
        run: |
          git config user.name "SectionFlow Healing Bot"
          git config user.email "healing-bot@dreamstack.us"
          git add -A
          git diff --staged --quiet || git commit -m "fix(${{ inputs.error_type }}): auto-heal ${{ inputs.issue_id }}"
          git push origin bugfix/auto-heal-${{ inputs.issue_id }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: bugfix/auto-heal-${{ inputs.issue_id }}
          base: main
          title: "fix(${{ inputs.error_type }}): auto-heal ${{ inputs.issue_id }}"
          body: |
            ## Auto-Heal PR

            **Issue ID:** `${{ inputs.issue_id }}`
            **Error Type:** `${{ inputs.error_type }}`

            ### Error Context
            ```
            ${{ inputs.error_context }}
            ```

            ### Analysis
            ${{ inputs.analysis }}

            ---

            *This PR was automatically generated by the SectionFlow Self-Healing System.*
            *Please review carefully before merging.*

            - [ ] Code changes are minimal and targeted
            - [ ] TypeScript types are correct
            - [ ] Build succeeds
          labels: |
            auto-heal
            bot

      - name: Notify Slack on success
        if: success()
        continue-on-error: true
        run: |
          curl -X POST ${{ secrets.SLACK_RELEASES_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "SectionFlow Auto-Heal PR created for issue ${{ inputs.issue_id }} - ready for review"
            }'

      - name: Notify Slack on failure
        if: failure()
        continue-on-error: true
        run: |
          curl -X POST ${{ secrets.SLACK_RELEASES_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "SectionFlow Auto-Heal failed for issue ${{ inputs.issue_id }} - manual intervention required"
            }'
